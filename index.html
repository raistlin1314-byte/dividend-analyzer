<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>险资红利策略 ERP 分析</title>
    
    <script crossorigin src="https://cdn.bootcdn.net/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.bootcdn.net/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdn.bootcdn.net/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script crossorigin src="https://cdn.bootcdn.net/ajax/libs/recharts/2.12.3/Recharts.min.js"></script>
    <script crossorigin src="https://cdn.bootcdn.net/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; }
        
        /* 布局容器 */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* 头部样式 */
        header { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 24px; color: #1a1a1a; }
        .subtitle { color: #666; font-size: 14px; margin-top: 5px; }
        
        /* 周期切换按钮 */
        .btn-group { background: #f5f5f5; padding: 4px; border-radius: 6px; display: flex; gap: 5px; }
        .btn { border: none; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; background: transparent; color: #666; transition: all 0.2s; }
        .btn.active { background: #1890ff; color: #fff; box-shadow: 0 2px 4px rgba(24,144,255,0.2); }
        .btn:hover:not(.active) { background: #e6e6e6; }

        /* 主内容网格布局 */
        .main-grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: 600px; }
        
        /* 左侧股票列表 */
        .stock-list-panel { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; background: #fafafa; }
        .list-content { overflow-y: auto; flex: 1; }
        
        .stock-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
        .stock-item:hover { background-color: #f0f7ff; }
        .stock-item.active { background-color: #e6f7ff; border-left: 4px solid #1890ff; padding-left: 11px; }
        .stock-name { font-weight: bold; font-size: 15px; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .stock-info { font-size: 12px; color: #999; display: flex; justify-content: space-between; }
        .yield-high { color: #cf1322; font-weight: bold; }

        /* 右侧图表区域 */
        .chart-panel { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 20px; display: flex; flex-direction: column; }
        .chart-header { margin-bottom: 20px; font-size: 18px; font-weight: bold; color: #333; }
        .chart-container { flex: 1; min-height: 0; position: relative; }

        /* 加载与错误状态 */
        .center-msg { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1890ff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; height: auto; }
            .stock-list-panel { height: 300px; }
            .chart-panel { height: 400px; }
        }
    </style>
</head>
<body>

    <div id="root">
        <div class="center-msg">
            <div class="spinner"></div>
            <p>正在初始化分析系统...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { ComposedChart, Line, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        const App = () => {
            const [data, setData] = useState({ pool: [], erp: {} });
            const [selectedStock, setSelectedStock] = useState(null);
            const [period, setPeriod] = useState('5y');
            const [status, setStatus] = useState('loading');
            const [errorMsg, setErrorMsg] = useState('');

            // 加载数据
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const t = new Date().getTime();
                        const [poolRes, erpRes] = await Promise.all([
                            fetch(`./data/stock_pool.json?t=${t}`),
                            fetch(`./data/erp_data.json?t=${t}`)
                        ]);

                        if (!poolRes.ok || !erpRes.ok) throw new Error("数据文件读取失败");

                        const poolData = await poolRes.json();
                        const erpData = await erpRes.json();

                        if (!poolData.stocks || !erpData.stocks) throw new Error("数据格式错误");

                        setData({ pool: poolData.stocks, erp: erpData.stocks });
                        if (poolData.stocks.length > 0) {
                            setSelectedStock(poolData.stocks[0].ts_code);
                        }
                        setStatus('success');
                    } catch (err) {
                        setStatus('error');
                        setErrorMsg(err.message);
                    }
                };
                loadData();
            }, []);

            // 准备图表数据
            const chartData = useMemo(() => {
                if (!selectedStock || !data.erp[selectedStock]) return [];
                const stock = data.erp[selectedStock];
                const stats = stock.rolling_stats[period];
                if (!stats) return [];

                return stock.dates.map((d, i) => ({
                    date: d,
                    erp: stock.erp[i],
                    mean: stats.mean[i],
                    p1: stats.p1std[i], p2: stats.p2std[i],
                    m1: stats.m1std[i], m2: stats.m2std[i]
                }));
            }, [data, selectedStock, period]);

            // 错误渲染
            if (status === 'error') {
                return (
                    <div className="center-msg" style={{color: 'red'}}>
                        <h2>⚠️ 加载失败</h2>
                        <p>{errorMsg}</p>
                        <p style={{fontSize: '12px', color: '#666'}}>请确保 data 文件夹已上传至 GitHub</p>
                    </div>
                );
            }

            // 加载中渲染
            if (status === 'loading') return null;

            // 正常渲染
            return (
                <div className="container">
                    <header>
                        <div>
                            <h1>险资红利策略 ERP 分析</h1>
                            <div className="subtitle">共筛选出 {data.pool.length} 只高股息标的</div>
                        </div>
                        <div className="btn-group">
                            {['3y', '5y', '10y'].map(p => (
                                <button 
                                    key={p} 
                                    onClick={() => setPeriod(p)}
                                    className={`btn ${period === p ? 'active' : ''}`}
                                >
                                    {p.toUpperCase()} 周期
                                </button>
                            ))}
                        </div>
                    </header>

                    <div className="main-grid">
                        {/* 左侧列表 */}
                        <div className="stock-list-panel">
                            <div className="panel-header">股票池</div>
                            <div className="list-content">
                                {data.pool.map(stock => (
                                    <div 
                                        key={stock.ts_code}
                                        onClick={() => setSelectedStock(stock.ts_code)}
                                        className={`stock-item ${selectedStock === stock.ts_code ? 'active' : ''}`}
                                    >
                                        <div className="stock-name">
                                            <span>{stock.name}</span>
                                            <span className="yield-high">{(stock.dividend_yield * 100).toFixed(2)}%</span>
                                        </div>
                                        <div className="stock-info">
                                            <span>{stock.ts_code}</span>
                                            <span>{(stock.total_mv / 10000).toFixed(0)}亿</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* 右侧图表 */}
                        <div className="chart-panel">
                            <div className="chart-header">
                                {selectedStock && data.pool.find(s => s.ts_code === selectedStock)?.name} 
                                <span style={{fontSize: '14px', fontWeight: 'normal', color: '#666', marginLeft: '10px'}}>
                                    ERP 滚动标准差通道
                                </span>
                            </div>
                            
                            <div className="chart-container">
                                <ResponsiveContainer width="100%" height="100%">
                                    <ComposedChart data={chartData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e8e8e8" />
                                        <XAxis dataKey="date" tick={{fontSize: 11}} minTickGap={50} />
                                        <YAxis unit="%" tick={{fontSize: 11}} domain={['auto', 'auto']} />
                                        <Tooltip 
                                            contentStyle={{borderRadius: '4px', border: 'none', boxShadow: '0 2px 8px rgba(0,0,0,0.15)'}}
                                            formatter={(value) => value.toFixed(2) + '%'}
                                            labelStyle={{color: '#666'}}
                                        />
                                        <Legend verticalAlign="top" height={36}/>
                                        
                                        <Area type="monotone" dataKey="p2" stackId="2" stroke="none" fill="#ffccc7" fillOpacity={0.6} name="+2σ (警戒)" />
                                        <Area type="monotone" dataKey="m2" stackId="3" stroke="none" fill="#ffccc7" fillOpacity={0.6} name="-2σ (低估)" />
                                        <Area type="monotone" dataKey="p1" stackId="4" stroke="none" fill="#ffe7ba" fillOpacity={0.6} name="+1σ" />
                                        <Area type="monotone" dataKey="m1" stackId="5" stroke="none" fill="#ffe7ba" fillOpacity={0.6} name="-1σ" />
                                        
                                        <Line type="monotone" dataKey="mean" stroke="#8c8c8c" strokeDasharray="5 5" dot={false} name="历史均值" />
                                        <Line type="monotone" dataKey="erp" stroke="#1890ff" strokeWidth={2} dot={false} activeDot={{r: 5}} name="当前 ERP" />
                                    </ComposedChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
