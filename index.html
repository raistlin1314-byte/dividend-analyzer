<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™©èµ„çº¢åˆ©ç­–ç•¥ ERP åˆ†æ</title>
    
    <script crossorigin src="https://cdn.staticfile.org/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.org/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.org/recharts/2.10.3/Recharts.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.org/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>

    <div id="error-box" style="display:none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 9999; padding: 40px; text-align: center;">
        <div style="max-width: 600px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 1px solid #fee2e2;">
            <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
            <h2 style="color: #dc2626; margin-bottom: 10px; font-size: 20px; font-weight: bold;">å‘ç”Ÿé”™è¯¯</h2>
            <p id="error-message" style="color: #4b5563; font-family: monospace; background: #f3f4f6; padding: 15px; border-radius: 6px; word-break: break-all; text-align: left;"></p>
        </div>
    </div>

    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 15px; color: #64748b;">æ­£åœ¨ä»å›½å†…é•œåƒæºåŠ è½½ç»„ä»¶...</p>
        </div>
    </div>

    <script>
        function showError(msg) {
            document.getElementById('root').style.display = 'none';
            const errorBox = document.getElementById('error-box');
            const errorText = document.getElementById('error-message');
            errorBox.style.display = 'block';
            errorText.textContent = msg;
            console.error(msg);
        }

        window.onload = function() {
            // äºŒæ¬¡æ£€æŸ¥ï¼šç¡®ä¿å…³é”®åº“å·²å°±ä½
            if (!window.React) return showError("React åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–å°è¯•åˆ·æ–°ã€‚");
            if (!window.Recharts) return showError("Recharts åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–å°è¯•åˆ·æ–°ã€‚");
        };
    </script>

    <script type="text/babel">
        const React = window.React;
        const { useState, useEffect, useMemo } = React;
        const Recharts = window.Recharts;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Line, ComposedChart } = Recharts;

        const App = () => {
            const [data, setData] = useState({ pool: [], erp: {} });
            const [selectedStock, setSelectedStock] = useState(null);
            const [period, setPeriod] = useState('5y');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const loadData = async () => {
                    try {
                        // ä½¿ç”¨æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                        const ts = new Date().getTime();
                        const [poolRes, erpRes] = await Promise.all([
                            fetch(`./data/stock_pool.json?t=${ts}`),
                            fetch(`./data/erp_data.json?t=${ts}`)
                        ]);

                        if (!poolRes.ok) throw new Error(`stock_pool.json è¯»å–å¤±è´¥ (${poolRes.status})`);
                        if (!erpRes.ok) throw new Error(`erp_data.json è¯»å–å¤±è´¥ (${erpRes.status})`);

                        const poolData = await poolRes.json();
                        const erpData = await erpRes.json();
                        
                        if (!poolData.stocks || !erpData.stocks) {
                            throw new Error("JSON æ•°æ®æ ¼å¼å¼‚å¸¸");
                        }

                        setData({ pool: poolData.stocks, erp: erpData.stocks });
                        
                        if (poolData.stocks.length > 0) {
                            setSelectedStock(poolData.stocks[0].ts_code);
                        }
                        setLoading(false);
                    } catch (err) {
                        showError("æ•°æ®åŠ è½½é”™è¯¯: " + err.message);
                    }
                };
                loadData();
            }, []);

            const chartData = useMemo(() => {
                if (!selectedStock || !data.erp[selectedStock]) return [];
                const stock = data.erp[selectedStock];
                if (!stock.rolling_stats || !stock.rolling_stats[period]) return [];
                
                const stats = stock.rolling_stats[period];
                return stock.dates.map((d, i) => ({
                    date: d,
                    erp: stock.erp[i],
                    mean: stats.mean[i],
                    p1: stats.p1std[i], p2: stats.p2std[i],
                    m1: stats.m1std[i], m2: stats.m2std[i]
                }));
            }, [data, selectedStock, period]);

            if (loading) return null;

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-6 min-h-screen">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-800">
                                ğŸ›¡ï¸ é™©èµ„çº¢åˆ©ç­–ç•¥ <span className="text-blue-600">ERP åˆ†æ</span>
                            </h1>
                            <p className="text-sm text-slate-500 mt-1">
                                æ•°æ®æºï¼šTushare Pro | æ ‡çš„æ•°é‡ï¼š{data.pool.length}
                            </p>
                        </div>
                        <div className="flex bg-white rounded-lg border p-1 shadow-sm">
                            {['3y', '5y', '10y'].map(p => (
                                <button
                                    key={p}
                                    onClick={() => setPeriod(p)}
                                    className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all ${
                                        period === p 
                                        ? 'bg-blue-600 text-white shadow' 
                                        : 'text-slate-600 hover:bg-slate-50'
                                    }`}
                                >
                                    {p.toUpperCase()} å‘¨æœŸ
                                </button>
                            ))}
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div className="lg:col-span-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[600px]">
                            <div className="p-3 bg-slate-50 border-b font-medium text-sm text-slate-700">
                                è‚¡ç¥¨æ±  ({data.pool.length})
                            </div>
                            <div className="flex-1 overflow-y-auto">
                                {data.pool.map(stock => (
                                    <div
                                        key={stock.ts_code}
                                        onClick={() => setSelectedStock(stock.ts_code)}
                                        className={`p-3 border-b border-slate-50 cursor-pointer hover:bg-blue-50 transition-colors ${
                                            selectedStock === stock.ts_code ? 'bg-blue-50 border-l-4 border-l-blue-600' : 'border-l-4 border-l-transparent'
                                        }`}
                                    >
                                        <div className="flex justify-between font-bold text-slate-800 text-sm">
                                            <span>{stock.name}</span>
                                            <span className="text-red-600">{(stock.dividend_yield * 100).toFixed(2)}%</span>
                                        </div>
                                        <div className="flex justify-between text-xs text-slate-400 mt-1">
                                            <span>{stock.ts_code}</span>
                                            <span>{(stock.total_mv/10000).toFixed(0)}äº¿</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-4 h-[600px] flex flex-col">
                            <div className="mb-4 flex justify-between items-center">
                                <h3 className="font-bold text-slate-700">
                                    {selectedStock && data.pool.find(s=>s.ts_code === selectedStock)?.name} - ERP æ³¢åŠ¨åŒºé—´
                                </h3>
                            </div>
                            
                            <div className="flex-1 w-full min-h-0">
                                <ResponsiveContainer width="100%" height="100%">
                                    <ComposedChart data={chartData} margin={{top:10, right:30, left:0, bottom:0}}>
                                        <defs>
                                            <linearGradient id="colorErp" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#2563eb" stopOpacity={0.1}/>
                                                <stop offset="95%" stopColor="#2563eb" stopOpacity={0}/>
                                            </linearGradient>
                                        </defs>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                        <XAxis dataKey="date" tick={{fontSize:11}} minTickGap={50} tickLine={false} axisLine={{stroke:'#cbd5e1'}} />
                                        <YAxis unit="%" tick={{fontSize:11}} tickLine={false} axisLine={false} domain={['auto', 'auto']} />
                                        <Tooltip 
                                            contentStyle={{borderRadius:'8px', border:'none', boxShadow:'0 4px 6px -1px rgba(0,0,0,0.1)'}}
                                            formatter={(val) => val.toFixed(2) + '%'}
                                            labelStyle={{color:'#64748b', marginBottom:'5px'}}
                                        />
                                        <Legend verticalAlign="top" height={36} />

                                        <Area type="monotone" dataKey="p2" stackId="2" stroke="none" fill="#fee2e2" fillOpacity={0.5} name="+2Ïƒ (è­¦æˆ’)" />
                                        <Area type="monotone" dataKey="m2" stackId="3" stroke="none" fill="#fee2e2" fillOpacity={0.5} name="-2Ïƒ (æœºä¼š)" />
                                        <Area type="monotone" dataKey="p1" stackId="4" stroke="none" fill="#ffedd5" fillOpacity={0.6} name="+1Ïƒ" />
                                        <Area type="monotone" dataKey="m1" stackId="5" stroke="none" fill="#ffedd5" fillOpacity={0.6} name="-1Ïƒ" />
                                        
                                        <Line type="monotone" dataKey="mean" stroke="#94a3b8" strokeDasharray="5 5" dot={false} strokeWidth={1.5} name="å‡å€¼" />
                                        <Line type="monotone" dataKey="erp" stroke="#2563eb" strokeWidth={2.5} dot={false} activeDot={{r:6}} name="å½“å‰ ERP" />
                                    </ComposedChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="mt-2 text-center text-xs text-slate-400">
                                ERP = è‚¡æ¯ç‡ - æ— é£é™©åˆ©ç‡ | å¤„äºä¸‹æ–¹çº¢è‰²åŒºåŸŸ(>å‡å€¼-2Ïƒ)é€šå¸¸ä»£è¡¨ä¼°å€¼åä½
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>