<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™©èµ„çº¢åˆ©ç­–ç•¥ ERP åˆ†æ</title>
    
    <script src="https://cdn.bootcdn.net/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>

    <script crossorigin src="https://cdn.bootcdn.net/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.bootcdn.net/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <script crossorigin src="https://cdn.bootcdn.net/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    
    <script crossorigin src="https://cdn.bootcdn.net/ajax/libs/recharts/2.12.3/Recharts.min.js"></script>
    
    <script crossorigin src="https://cdn.bootcdn.net/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f3f4f6; }
        .loading-box { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; color: #6b7280; }
        .spinner { border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body>

    <div id="crash-screen" style="display:none; position: fixed; inset: 0; background: white; z-index: 9999; padding: 40px; text-align: center;">
        <h1 style="color: #ef4444; font-size: 24px; margin-bottom: 20px;">âš ï¸ æ— æ³•å¯åŠ¨</h1>
        <p id="crash-reason" style="color: #374151; font-family: monospace; background: #fef2f2; padding: 15px; border-radius: 8px; max-width: 600px; margin: 0 auto;"></p>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">åˆ·æ–°é‡è¯•</button>
    </div>

    <div id="root">
        <div class="loading-box">
            <div class="spinner"></div>
            <p>æ­£åœ¨ä» BootCDN åŠ è½½èµ„æº...</p>
        </div>
    </div>

    <script>
        // é”™è¯¯å¤„ç†å‡½æ•°
        function reportCrash(msg) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('crash-screen').style.display = 'block';
            document.getElementById('crash-reason').textContent = msg;
            console.error(msg);
        }

        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½æˆåŠŸ
        window.onload = function() {
            // å…¼å®¹æ€§å¤„ç†ï¼šRecharts æœ‰æ—¶ä¼šæŒ‚è½½åœ¨ window.Recharts æˆ– window.recharts
            if (!window.React) return reportCrash("React åŠ è½½å¤±è´¥ (BootCDN)");
            if (!window.ReactDOM) return reportCrash("ReactDOM åŠ è½½å¤±è´¥ (BootCDN)");
            if (!window.Recharts) return reportCrash("Recharts åŠ è½½å¤±è´¥ (BootCDN) - è¯·å°è¯•ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°");
            
            // å¦‚æœéƒ½æˆåŠŸï¼Œæ§åˆ¶å°è¾“å‡º
            console.log("æ‰€æœ‰åº“åŠ è½½æˆåŠŸï¼Œå¯åŠ¨ App...");
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Line, ComposedChart } = Recharts;

        const App = () => {
            const [data, setData] = useState({ pool: [], erp: {} });
            const [selectedStock, setSelectedStock] = useState(null);
            const [period, setPeriod] = useState('5y');
            const [status, setStatus] = useState('loading');
            const [errorMsg, setErrorMsg] = useState('');

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                        const t = new Date().getTime();
                        const [poolRes, erpRes] = await Promise.all([
                            fetch(`./data/stock_pool.json?t=${t}`),
                            fetch(`./data/erp_data.json?t=${t}`)
                        ]);

                        if (!poolRes.ok) throw new Error("æ— æ³•è¯»å– stock_pool.json");
                        if (!erpRes.ok) throw new Error("æ— æ³•è¯»å– erp_data.json");

                        const pool = await poolRes.json();
                        const erp = await erpRes.json();
                        
                        // ç®€å•æ ¡éªŒ
                        if (!pool.stocks || !erp.stocks) throw new Error("æ•°æ®æ ¼å¼é”™è¯¯: ç¼ºå°‘ stocks å­—æ®µ");

                        setData({ pool: pool.stocks, erp: erp.stocks });
                        if (pool.stocks.length > 0) setSelectedStock(pool.stocks[0].ts_code);
                        setStatus('ready');
                    } catch (e) {
                        setStatus('error');
                        setErrorMsg(e.message);
                    }
                };
                fetchData();
            }, []);

            const chartData = useMemo(() => {
                if (!selectedStock || !data.erp[selectedStock]) return [];
                const s = data.erp[selectedStock];
                if (!s.rolling_stats || !s.rolling_stats[period]) return [];
                const stats = s.rolling_stats[period];
                
                return s.dates.map((d, i) => ({
                    date: d,
                    erp: s.erp[i],
                    mean: stats.mean[i],
                    p1: stats.p1std[i], p2: stats.p2std[i],
                    m1: stats.m1std[i], m2: stats.m2std[i]
                }));
            }, [data, selectedStock, period]);

            if (status === 'error') {
                return (
                    <div className="flex flex-col items-center justify-center h-screen text-red-500">
                        <div className="text-4xl mb-2">âŒ</div>
                        <p>æ•°æ®åŠ è½½é”™è¯¯ï¼š{errorMsg}</p>
                        <p className="text-sm text-gray-400 mt-2">è¯·æ£€æŸ¥ GitHub ä»“åº“ä¸­æ˜¯å¦æœ‰ data æ–‡ä»¶å¤¹</p>
                    </div>
                );
            }

            if (status === 'loading') return null;

            return (
                <div className="max-w-7xl mx-auto p-4 lg:p-8 min-h-screen">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">
                                ğŸ“Š é™©èµ„çº¢åˆ©ç­–ç•¥ ERP åˆ†æ
                            </h1>
                            <p className="text-sm text-gray-500 mt-1">
                                å·²ç­›é€‰ {data.pool.length} åªæ ‡çš„ â€¢ æ•°æ®æº: Tushare
                            </p>
                        </div>
                        <div className="flex bg-white rounded p-1 shadow-sm border">
                            {['3y', '5y', '10y'].map(p => (
                                <button key={p} onClick={() => setPeriod(p)}
                                    className={`px-4 py-1.5 text-sm font-medium rounded transition-colors ${
                                        period === p ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-50'
                                    }`}>
                                    {p.toUpperCase()}
                                </button>
                            ))}
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 h-[600px]">
                        {/* å·¦ä¾§åˆ—è¡¨ */}
                        <div className="bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                            <div className="p-3 bg-gray-50 border-b font-medium text-sm text-gray-700">è‚¡ç¥¨æ± </div>
                            <div className="flex-1 overflow-y-auto">
                                {data.pool.map(s => (
                                    <div key={s.ts_code} onClick={() => setSelectedStock(s.ts_code)}
                                         className={`p-3 border-b cursor-pointer transition-colors ${
                                             selectedStock === s.ts_code ? 'bg-blue-50 border-l-4 border-l-blue-600' : 'border-l-4 border-l-transparent hover:bg-gray-50'
                                         }`}>
                                        <div className="flex justify-between font-bold text-gray-800 text-sm">
                                            <span>{s.name}</span>
                                            <span className="text-red-600">{(s.dividend_yield*100).toFixed(2)}%</span>
                                        </div>
                                        <div className="text-xs text-gray-400 mt-1">{s.ts_code}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* å³ä¾§å›¾è¡¨ */}
                        <div className="lg:col-span-3 bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col">
                            <h3 className="font-bold text-gray-700 mb-4">
                                ERP æ»šåŠ¨é€šé“ ({data.pool.find(s=>s.ts_code===selectedStock)?.name})
                            </h3>
                            <div style={{ flex: 1, minHeight: 0 }}>
                                <ResponsiveContainer width="100%" height="100%">
                                    <ComposedChart data={chartData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <XAxis dataKey="date" tick={{fontSize:11}} minTickGap={50} />
                                        <YAxis unit="%" domain={['auto', 'auto']} tick={{fontSize:11}} />
                                        <Tooltip labelStyle={{color:'#666'}} formatter={(v)=>v.toFixed(2)+'%'} />
                                        <Legend verticalAlign="top" height={36}/>
                                        
                                        <Area type="monotone" dataKey="p2" stackId="2" fill="#fee2e2" stroke="none" fillOpacity={0.5} name="+2Ïƒ (è­¦æˆ’)" />
                                        <Area type="monotone" dataKey="m2" stackId="3" fill="#fee2e2" stroke="none" fillOpacity={0.5} name="-2Ïƒ (ä½ä¼°)" />
                                        <Area type="monotone" dataKey="p1" stackId="4" fill="#ffedd5" stroke="none" fillOpacity={0.5} name="+1Ïƒ" />
                                        <Area type="monotone" dataKey="m1" stackId="5" fill="#ffedd5" stroke="none" fillOpacity={0.5} name="-1Ïƒ" />
                                        
                                        <Line type="monotone" dataKey="mean" stroke="#9ca3af" strokeDasharray="5 5" dot={false} name="å‡å€¼" />
                                        <Line type="monotone" dataKey="erp" stroke="#2563eb" strokeWidth={2} dot={false} activeDot={{r:5}} name="å½“å‰ERP" />
                                    </ComposedChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
